<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="icon" type="image/x-icon" href="unnamed.png">
<title>INEC PVC Registration — Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<script>
  // Redirect to login if not authenticated
  if (localStorage.getItem("loggedIn") !== "true") {
    window.location.href = "error.html";
  }
</script>
<style>
:root{
  --green:#0a7a3b; --green-2:#086331; --bg:#f4fbf6; --muted:#6b7280; --card:#fff; --radius:14px;
}
*{box-sizing:border-box}
body{font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial; margin:0; background:linear-gradient(180deg,#f7fbf7,#f1faf3); color:#1f2937;}
.container{max-width:1100px;margin:28px auto;padding:18px;}
h1{color:var(--green-2);text-align:center;margin-bottom:12px}

/* Card + watermark */
.card{position:relative;background:var(--card);border-radius:var(--radius);padding:20px;border:1px solid #e6eef0;box-shadow:0 10px 30px rgba(10,122,59,0.06);margin-bottom:18px;overflow:hidden}
.card::before{content:"";position:absolute;left:50%;top:50%;width:320px;height:320px;transform:translate(-50%,-50%);background:url("YOUR_LOGO.png") center/contain no-repeat;opacity:.08;pointer-events:none;filter:grayscale(100%);animation:sealPulse 8s ease-in-out infinite}
@keyframes sealPulse{0%,100%{opacity:.08;transform:translate(-50%,-50%) scale(1)}50%{opacity:.12;transform:translate(-50%,-50%) scale(1.02)}}

/* stepper */
.step-dots{display:flex;gap:12px;justify-content:space-between;margin-bottom:10px}
.step-dot{display:flex;gap:10px;align-items:center;cursor:pointer}
.dot{width:30px;height:30px;border-radius:50%;border:2px solid var(--green);display:grid;place-items:center;background:#fff;color:var(--green)}
.step-label{font-size:13px;color:var(--muted)}
.step-dot.active .dot{background:var(--green);color:#fff}
.step-dot.active .step-label{color:var(--green-2);font-weight:700}
.progress{height:8px;background:#eef6ef;border-radius:999px;overflow:hidden;margin-bottom:14px}
.progress-fill{height:100%;width:0;background:linear-gradient(90deg,var(--green),#15a65b);transition:width .35s cubic-bezier(.2,.7,.2,1)}

/* grid & fields */
.grid{display:grid;gap:14px}
@media(min-width:760px){.cols-2{grid-template-columns:1fr 1fr}}
label{display:block;font-weight:600;margin-bottom:6px}
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef0;font:inherit}
textarea{min-height:84px}
.hint{font-size:12px;color:var(--muted)}
.error{display:none;background:#dc4b4b;color:#fff;padding:6px;border-radius:8px;font-size:13px}
.error.show{display:inline-block}

/* buttons */
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.btn{padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
.btn.primary{background:var(--green);color:#fff}
.btn.ghost{background:#fff;color:var(--green);border:1px solid var(--green)}
.btn:active{transform:translateY(1px)}
.btn-outline{background:#fff;border:1px solid var(--green);color:var(--green)}

/* table + filters */
.table-actions{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.filters input{padding:9px;border-radius:8px;border:1px solid #e6eef0}
.table-wrap{overflow:auto;max-height:480px;border-radius:8px;border:1px solid #e6eef0}
table{width:100%;border-collapse:collapse}
thead th{position:sticky;top:0;background:linear-gradient(180deg,var(--green),var(--green-2));color:#fff;padding:12px;text-align:left}
tbody td{padding:10px;border-bottom:1px solid #eef6f0;background:#fff}
tbody tr:hover{background:#f6fbf7}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef8f1;color:var(--green-2);font-weight:600;font-size:12px}
.thumb{width:36px;height:36px;border-radius:6px;object-fit:cover;border:1px solid #e6eef0}

/* modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1200;align-items:center;justify-content:center}
.modal[aria-hidden="true"]{display:none}
.modal-card{background:#fff;padding:18px;border-radius:12px;max-width:820px;width:92%;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.modal-close{float:right;border:0;background:transparent;font-size:20px;cursor:pointer}

/* loader */
.loader-overlay{display:none;position:fixed;inset:0;background:rgba(255,255,255,0.85);z-index:20000;display:flex;flex-direction:column;align-items:center;justify-content:center}
.spinner{border:6px solid #e0e0e0;border-top:6px solid var(--green);border-radius:50%;width:56px;height:56px;animation:spin 1s linear infinite;margin-bottom:12px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
  <div class="container">
   
      <h1>Permanent Voter’s Card (PVC) — Pre-Registration</h1>
      <button onclick="logout()" style="background-color:#0a7a3b; color:#fff; border: none; border-radius: 4px; padding: 5px 10px; margin-bottom: 10px; cursor:pointer; margin-left: 10px;">Logout</button>
  

    <!-- Form Card -->
    <div class="card" id="formCard">
      <div class="step-dots" aria-hidden="true">
        <div class="step-dot active" data-step="0"><div class="dot">1</div><div class="step-label">Personal</div></div>
        <div class="step-dot" data-step="1"><div class="dot">2</div><div class="step-label">Address</div></div>
        <div class="step-dot" data-step="2"><div class="dot">3</div><div class="step-label">Identification</div></div>
        <div class="step-dot" data-step="3"><div class="dot">4</div><div class="step-label">Review</div></div>
      </div>
      <div class="progress"><div id="progressFill" class="progress-fill"></div></div>

      <form id="pvcForm" novalidate>
        <div class="grid cols-2">
          <!-- Step 0: Personal -->
          <section class="step active" data-step="0">
            <div class="field">
              <label for="fullName">Full Name *</label>
              <input id="fullName" name="fullName" />
              <div class="error" id="err-fullName">Full name required</div>
            </div>
            <div class="field">
              <label for="dob">Date of Birth *</label>
              <input id="dob" name="dob" type="date" />
              <div class="hint">Applicants must be 18+</div>
              <div class="error" id="err-dob">You must be at least 18</div>
            </div>
            <div class="field">
              <label for="phone">Phone (NG) *</label>
              <input id="phone" name="phone" />
              <div class="error" id="err-phone">Enter a valid Nigerian phone number</div>
            </div>
            <div class="field">
              <label for="email">Email</label>
              <input id="email" name="email" type="email" />
              <div class="error" id="err-email">Valid email required</div>
            </div>
            <div class="field">
              <label for="gender">Gender *</label>
              <select id="gender" name="gender"><option value="">Select…</option><option>Male</option><option>Female</option><option>Other</option></select>
              <div class="error" id="err-gender">Select gender</div>
            </div>
            <div class="field">
              <label for="occupation">Occupation</label>
              <input id="occupation" name="occupation" placeholder="e.g., Teacher, Trader" />
            </div>
          </section>

          <!-- Step 1: Address -->
          <section class="step" data-step="1">
            <div class="field">
              <label for="state">State *</label>
              <select id="state" name="state"></select>
              <div class="error" id="err-state">Select a state</div>
            </div>
            <div class="field">
              <label for="lga">LGA *</label>
              <select id="lga" name="lga"><option value="">Select LGA…</option></select>
              <div class="error" id="err-lga">Select an LGA</div>
            </div>
            <div class="field">
              <label for="ward">Ward</label>
              <select id="ward" name="ward"><option value="">Select Ward…</option></select>
              <div class="error" id="err-ward">Select a ward</div>
            </div>
            <div class="field" style="grid-column:1/-1">
              <label for="address">Residential Address *</label>
              <textarea id="address" name="address"></textarea>
              <div class="error" id="err-address">Enter address</div>
            </div>
          </section>

          <!-- Step 2: ID -->
          <section class="step" data-step="2">
            <div class="field">
              <label for="nin">NIN (11 digits) </label>
              <input id="nin" name="nin" maxlength="11" inputmode="numeric" />
              <div class="error" id="err-nin">11-digit NIN required</div>
            </div>
            <div class="field">
              <label for="refNo">Reference Number *</label>
              <input id="refNo" name="refNo" />
              <div class="error" id="err-refNo">Reference required</div>
            </div>
            <div class="field">
              <label for="passport">Passport Photo (JPG/PNG ≤ 2MB)</label>
              <input id="passport" name="passport" type="file" accept="image/png,image/jpeg" />
              <div class="error" id="err-passport">File must be JPG/PNG and ≤ 2MB</div>
            </div>
            <div class="field">
              <label><input type="checkbox" id="disability" name="disability" /> Person with disability</label>
            </div>
          </section>

          <!-- Step 3: Review -->
          <section class="step" data-step="3">
            <div class="field" style="grid-column:1/-1">
              <label>Review & Consent</label>
              <p class="hint">Confirm details and consent to data processing.</p>
              <label><input type="checkbox" id="consent" name="consent" /> I consent *</label>
              <div class="error" id="err-consent">Consent required</div>
            </div>
          </section>
        </div>

        <div class="actions">
          <button type="button" class="btn ghost" id="prevBtn">Back</button>
          <button type="button" class="btn primary" id="nextBtn">Next</button>
          <button type="submit" class="btn primary" id="submitBtn" style="display:none">Submit</button>
        </div>
      </form>
    </div>

    <!-- Table Card -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
        <div style="font-weight:700">Submitted Applications</div>
        <div class="filters" style="margin-top:8px">
          <input id="search" placeholder="Search name/state/LGA/email/phone…" />
          <input id="startDate" type="date" />
          <input id="endDate" type="date" />
          <button class="btn ghost" id="clearFilters">Clear Filters</button>
          <div style="display:flex;gap:8px">
            <button class="btn btn-outline" id="exportCSV" disabled>Export CSV</button>
            <button class="btn btn-outline" id="exportXLSX" disabled>Export Excel</button>
          </div>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:12px">
        <table id="resultsTable">
          <thead>
            <tr>
              <th>Date</th><th>Photo</th><th>Full Name</th><th>State</th><th>LGA</th><th>Ward</th><th>Phone</th><th>Email</th><th>NIN</th><th>Disability</th><th>Occupation</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <!-- <p class="small" style="margin-top:10px;color:var(--muted)">Tip: replace watermark path and add Firebase config below to enable Cloud persistence. Without keys, LocalStorage is used.</p> -->
    </div>
  </div>

  <!-- Modal -->
  <div id="viewModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <button class="modal-close" id="modalCloseBtn" aria-label="Close record view">✕</button>
      <h3 id="modalTitle">Voter Record</h3>
      <div id="modalDetails" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader" class="loader-overlay" aria-hidden="true" style="display:none;align-items:center;">
    <div class="spinner" role="status" aria-hidden="true"></div>
    <div class="small">Submitting — please wait...</div>
  </div>

  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>

    function logout() {
      localStorage.removeItem("loggedIn");
      window.location.href = "index.html";
    }
  </script>

  <script type="module">

    
  /********************  CONFIGURE FIREBASE  ********************
   * Replace placeholders below with your Firebase project keys.
   * If you leave them as-is, the app will fallback to LocalStorage.
   *************************************************************/
  const firebaseConfig = {
        apiKey: "AIzaSyCzeXvcgkgLgQu1Pj2qce4wANvbe7ChWO4",
        authDomain: "gclc-eabb4.firebaseapp.com",
        databaseURL: "https://gclc-eabb4-default-rtdb.firebaseio.com",
        projectId: "gclc-eabb4",
        storageBucket: "gclc-eabb4.appspot.com",
        messagingSenderId: "588542989378",
        appId: "1:588542989378:web:ee83a42419ccaeac0249db"
  };
  const USE_FIREBASE = Object.values(firebaseConfig).every(v => typeof v === 'string' && !v.includes('YOUR_'));
  /*************************************************************/

  // Firebase variables (populated if enabled)
  let app, db, storage, addDoc, collection, getDocs, query, orderBy, serverTimestamp, ref, uploadBytes, getDownloadURL, deleteDoc, doc;

  if (USE_FIREBASE){
    const appMod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
    const fsMod  = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    const stMod  = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js');
    app = appMod.initializeApp(firebaseConfig);
    ({ getFirestore: db, addDoc, collection, getDocs, query, orderBy, serverTimestamp, deleteDoc, doc } = fsMod);
    ({ getStorage: storage, ref, uploadBytes, getDownloadURL } = stMod);
    db = db(app);
    storage = storage(app);
  }

  // Utilities & storage fallback
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const LS_KEY = 'pvc_submissions_v3';
  const readLocal = () => JSON.parse(localStorage.getItem(LS_KEY) || '[]');
  const writeLocal = (rows) => localStorage.setItem(LS_KEY, JSON.stringify(rows));
  const maskNIN = nin => nin ? nin.replace(/\d(?=\d{4})/g, '•') : '';
  const phoneNG = v => (v||'').replace(/\s+/g,'');
  const isValidPhoneNG = v => /^((\+?234)|0)[789][01]\d{8}$/.test(phoneNG(v));
  const isAdult = iso => { const d=new Date(iso); if (isNaN(+d)) return false; const e=new Date(d.getFullYear()+18,d.getMonth(),d.getDate()); return new Date() >= e; };
  function fmtDateTime(iso){ if(!iso) return ''; const d=new Date(iso); return d.toLocaleString(); }

  // State/LGA/Ward presets
  const STATE_LGAS = {
    'Lagos':['Ikeja','Surulere','Eti-Osa','Kosofe','Mushin','Ojo'],
    'Abuja':['Abaji','Bwari','Gwagwalada','Kuje','Kwali','Municipal Area Council'],
    'Kano':['Dala','Fagge','Gwale','Kumbotso','Tarauni']
  };
  const WARD_PRESETS = {
    'Lagos':['ADENIRAN/OGUNSANYA','AGUDA','AKINHANMI/COLE', 'COKER', 'IGBAJA/STADIUM', 'IJESHATEDO','IKATE', 'IPONRI HOUSING ESTATE/ERIC MOORE', 'SHITTA/OGUNLANA DRIVE', 'YABA/OJUELEGBA'],
    'Abuja':['Garki I','Wuse II','Asokoro','Maitama'],
    'Kano':['Fagge','Gwale','Kumbotso','Nassarawa']
  };
  // populate state select
  const stateSel = $('#state');
  stateSel.innerHTML = '<option value="">Select state…</option>' + Object.keys(STATE_LGAS).map(s=>`<option>${s}</option>`).join('');
  $('#state').addEventListener('change', ()=>{
    const list = STATE_LGAS[$('#state').value] || [];
    $('#lga').innerHTML = '<option value="">Select LGA…</option>' + list.map(l=>`<option>${l}</option>`).join('');
    const wards = WARD_PRESETS[$('#state').value] || [];
    $('#ward').innerHTML = '<option value="">Select Ward…</option>' + wards.map(w=>`<option>${w}</option>`).join('');
  });

  /***************** Stepper & Validation *****************/
  const steps = $$('.step');
  const dots = $$('.step-dot');
  const progressFill = $('#progressFill');
  let current = 0;
  function setStep(i){
    current = Math.max(0, Math.min(steps.length-1,i));
    steps.forEach((el,idx)=>el.classList.toggle('active', idx===current));
    dots.forEach((d,idx)=>d.classList.toggle('active', idx<=current));
    progressFill.style.width = (current/(steps.length-1))*100 + '%';
    $('#prevBtn').style.display = current===0 ? 'none' : '';
    $('#nextBtn').style.display = current===steps.length-1 ? 'none' : '';
    $('#submitBtn').style.display = current===steps.length-1 ? '' : 'none';
  }
  setStep(0);
  $('#prevBtn').addEventListener('click', ()=> setStep(current-1));
  $('#nextBtn').addEventListener('click', ()=> { if(validateStep(current)) setStep(current+1); });
  dots.forEach(d=> d.addEventListener('click', ()=> { const t=+d.dataset.step; if(t<=current||validateStep(current)) setStep(t); }));

  function showErr(id,ok){ const el=$('#err-'+id); if(!el) return ok; el.classList.toggle('show', !ok); return ok; }
  function validateStep(st){
    let ok=true;
    if(st===0){
      ok &= showErr('fullName', !!$('#fullName').value.trim());
      ok &= showErr('dob', isAdult($('#dob').value));
      ok &= showErr('phone', isValidPhoneNG($('#phone').value));
      // ok &= showErr('email', /.+@.+\..+/.test($('#email').value));
      ok &= showErr('gender', !!$('#gender').value);
    }
    if(st===1){
      ok &= showErr('state', !!$('#state').value);
      ok &= showErr('lga', !!$('#lga').value);
      // ok &= showErr('ward', !!$('#ward').value);
      ok &= showErr('address', !!$('#address').value.trim());
    }
    if(st===2){
      // ok &= showErr('nin', /^\d{11}$/.test($('#nin').value));
      ok &= showErr('refNo', !!$('#refNo').value.trim());
      const f = $('#passport').files[0];
      if(f){ const valid = ['image/jpeg','image/png'].includes(f.type) && f.size <= 2*1024*1024; ok &= showErr('passport', valid); }
    }
    if(st===3){
      ok &= showErr('consent', $('#consent').checked);
    }
    return !!ok;
  }

  /***************** Storage helpers *****************/
  async function uploadPassportIfAny(file){
    if(!file || !USE_FIREBASE) return null;
    const path = `pvc_passports/${Date.now()}_${Math.random().toString(36).slice(2)}_${file.name}`;
    const storageRef = ref(storage, path);
    await uploadBytes(storageRef, file);
    return await getDownloadURL(storageRef);
  }

  async function saveSubmissionToStore(data){
    const createdAt = new Date().toISOString();
    if (USE_FIREBASE){
      const coll = collection(db, 'pvc_registrations');
      const docRef = await addDoc(coll, {...data, createdAt});
      return { id: docRef.id, createdAt };
    } else {
      const rows = readLocal();
      const rec = { id:'local-'+Date.now(), ...data, createdAt };
      rows.unshift(rec);
      writeLocal(rows);
      return { id: rec.id, createdAt };
    }
  }

  /***************** Submit handler (with loader) *****************/
  $('#pvcForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!validateStep(3)) return;
    // show loader and disable submit
    $('#loader').style.display = 'flex';
    $('#loader').setAttribute('aria-hidden','false');
    $('#submitBtn').disabled = true;
    try{
      const file = $('#passport').files[0];
      const photoURL = await uploadPassportIfAny(file);
      const payload = {
        fullName: $('#fullName').value.trim() ,
        dob: $('#dob').value,
        phone: phoneNG($('#phone').value),
        email: $('#email').value.trim().toLowerCase() || '-',
        gender: $('#gender').value,
        occupation: $('#occupation').value.trim(),
        state: $('#state').value,
        lga: $('#lga').value,
        ward: $('#ward').value || '-',
        address: $('#address').value.trim(),
        nin: $('#nin').value || '-',
        refNo: $('#refNo').value.trim(),
        disability: $('#disability').checked,
        photoURL: photoURL || null
      };
      const result = await saveSubmissionToStore(payload);
      addRowToTable({ id: result.id, createdAt: result.createdAt, ...payload });
      // reset and go to step 0
      $('#pvcForm').reset();
      setStep(0);
      $('#lga').innerHTML = '<option value="">Select LGA…</option>';
      $('#ward').innerHTML = '<option value="">Select Ward…</option>';
      alert('Application submitted successfully!');
    }catch(err){
      console.error(err);
      alert('Submission failed — see console');
    }finally{
      $('#submitBtn').disabled = false;
      $('#loader').style.display = 'none';
      $('#loader').setAttribute('aria-hidden','true');
    }
  });

  /***************** Load data into table *****************/
  const recordsById = {};
  async function loadData(){
    const tbody = $('#resultsTable tbody');
    tbody.innerHTML = '<tr><td colspan="12" class="small">Loading…</td></tr>';
    let rows = [];
    if (USE_FIREBASE){
      try{
        const coll = collection(db,'pvc_registrations');
        const q = query(coll, orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        rows = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      }catch(e){ console.error(e); rows = []; }
    } else {
      rows = readLocal();
    }
    tbody.innerHTML = '';
    rows.forEach(r => { recordsById[r.id] = r; addRowToTable(r); });
    applyFilters();
  }
  await loadData();

  function addRowToTable(rec){
    const tbody = $('#resultsTable tbody');
    if (tbody.querySelector(`tr[data-id="${rec.id}"]`)) return;
    const tr = document.createElement('tr');
    tr.dataset.id = rec.id;
    tr.innerHTML = `
      <td>${fmtDateTime(rec.createdAt)}</td>
       <td>${rec.photoURL?`<a href="${rec.photoURL}" target="_blank" rel="noopener"><img class="thumb" src="${rec.photoURL}" alt="photo"></a>`:'—'}</td>
      <td>${rec.fullName||''}</td>
      <td>${rec.state||''}</td>
      <td>${rec.lga||''}</td>
      <td>${rec.ward||''}</td>
      <td>${rec.phone||''}</td>
      <td>${rec.email||''}</td>
      <td><span class="pill">${maskNIN(rec.nin||'')}</span></td>
      <td>${rec.disability?'<span class="pill">Yes</span>':'No'}</td>
      <td>${rec.occupation||''}</td>
      
      
      <td style="display: flex; column-gap: 5px;">
        <button class="btn view" data-id="${rec.id}"><i class="bi bi-eye"></i></button>
        <button class="btn delete" data-id="${rec.id}" style="background:#d03b3b; color: #fff;" ><i class="bi bi-trash"></i></button>
      </td>
    `;
    tbody.appendChild(tr);
    tr.querySelector('.view').addEventListener('click', ()=> viewRecord(rec.id));
    tr.querySelector('.delete').addEventListener('click', ()=> deleteRecord(rec.id));
    recordsById[rec.id] = rec;
  }

  /***************** Modal (accessible) *****************/
  const modal = $('#viewModal');
  const modalCloseBtn = $('#modalCloseBtn') || $('#modalCloseBtn'); // if id not present, fallback
  // ensure the close button has an id
  $('#modalCloseBtn')?.setAttribute?.('id','modalCloseBtn');
  $('#modalCloseBtn')?.addEventListener?.('click', closeModal);

  function viewRecord(id){
    const rec = recordsById[id];
    if(!rec) return alert('Record not found');
    const html = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        ${rec.photoURL? `<div style="grid-column:1/-1"><b>Photo</b><div style="margin-top:8px"><img src="${rec.photoURL}" alt="photo" style="max-width:160px;border-radius:8px;border:1px solid #eee"></div></div>` : ''}
        <div><b>Full Name</b><div class="small">${rec.fullName||''}</div></div>
        <div><b>Reference</b><div class="small">${rec.refNo||''}</div></div>
        <div><b>Email</b><div class="small">${rec.email||''}</div></div>
        <div><b>Phone</b><div class="small">${rec.phone||''}</div></div>
        <div><b>NIN</b><div class="small">${rec.nin||''}</div></div>
        <div><b>Disability</b><div class="small">${rec.disability? 'Yes':'No'}</div></div>
        <div style="grid-column:1/-1"><b>Address</b><div class="small">${rec.address||''}</div></div>
        <div><b>State</b><div class="small">${rec.state||''}</div></div>
        <div><b>LGA</b><div class="small">${rec.lga||''}</div></div>
        <div><b>Ward</b><div class="small">${rec.ward||''}</div></div>
        <div style="grid-column:1/-1"><b>Occupation</b><div class="small">${rec.occupation||''}</div></div>
        <div style="grid-column:1/-1"><b>Submitted</b><div class="small">${fmtDateTime(rec.createdAt)}</div></div>
       
      </div>
    `;
    $('#modalDetails').innerHTML = html;
    // show modal, focus close button
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    // set focus to close button safely after display
    const closeBtn = modal.querySelector('.modal-close');
    if(closeBtn){ closeBtn.focus(); }
    // store focused element to restore later
    modal.__returnFocus = document.activeElement;
  }

  function closeModal(){
    // move focus away from any element inside modal before hiding to avoid aria-hidden focus warning
    const returnFocus = modal.__returnFocus || (document.querySelector('.btn-outline') || document.body);
    try{ returnFocus.focus(); }catch(e){}
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }

  // close modal on outside click or Esc
  modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
  document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') closeModal(); });

  /***************** Delete record *****************/
  async function deleteRecord(id){
    if (!confirm('Delete this record? This action cannot be undone.')) return;
    try{
      if (USE_FIREBASE && !id.startsWith('local-')){
        await deleteDoc(doc(db,'pvc_registrations', id));
      } else {
        const rows = readLocal().filter(r => r.id !== id);
        writeLocal(rows);
      }
      const tr = $(`#resultsTable tbody tr[data-id="${id}"]`);
      if(tr) tr.remove();
      delete recordsById[id];
      applyFilters();
    }catch(e){ console.error(e); alert('Failed to delete — see console'); }
  }

  /***************** Filters & Clear *****************/
  function parseTableDate(text){ const d = new Date(text); return isNaN(+d)?null:d; }
  function applyFilters(){
    const q = $('#search').value.toLowerCase().trim();
    const start = $('#startDate').value ? new Date($('#startDate').value) : null;
    const end = $('#endDate').value ? new Date($('#endDate').value) : null;
    if(end) end.setHours(23,59,59,999);
    $$('#resultsTable tbody tr').forEach(tr=>{
      const hay = tr.textContent.toLowerCase();
      const dateText = tr.cells[0].textContent;
      const dateObj = parseTableDate(dateText);
      const matchText = !q || hay.includes(q);
      const matchDate = (!start && !end) || (dateObj && (!start || dateObj >= start) && (!end || dateObj <= end));
      tr.style.display = (matchText && matchDate) ? '' : 'none';
    });
  }
  $('#search').addEventListener('input', applyFilters);
  $('#startDate').addEventListener('change', applyFilters);
  $('#endDate').addEventListener('change', applyFilters);
  $('#clearFilters').addEventListener('click', ()=>{ $('#search').value=''; $('#startDate').value=''; $('#endDate').value=''; applyFilters(); });

  /***************** Export (visible rows only) *****************/
  function getVisibleRows(){ return $$('#resultsTable tbody tr').filter(tr => tr.style.display !== 'none'); }
  function exportCSV(){
    const header = Array.from($('#resultsTable thead tr').cells).map(h=>h.textContent.trim());
    const rows = [header];
    getVisibleRows().forEach(tr => rows.push(Array.from(tr.cells).slice(0,-1).map(td=>td.textContent.trim())));
    const csv = rows.map(r=> r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pvc_registrations.csv'; a.click(); URL.revokeObjectURL(a.href);
  }
  function exportXLSX(){
    const table = document.createElement('table'); table.appendChild($('#resultsTable thead').cloneNode(true));
    const tb = document.createElement('tbody'); getVisibleRows().forEach(tr => tb.appendChild(tr.cloneNode(true))); table.appendChild(tb);
    const wb = XLSX.utils.table_to_book(table, {sheet:'PVC'});
    XLSX.writeFile(wb, 'pvc_registrations.xlsx');
  }
  $('#exportCSV').addEventListener('click', exportCSV);
  $('#exportXLSX').addEventListener('click', exportXLSX);

  /***************** Init clickable step dots (jumping) *****************/
  $$('.step-dot').forEach(d => d.addEventListener('click', ()=> { const t = +d.dataset.step; if (t<=current || validateStep(current)) setStep(t); }));

  </script>
</body>
</html>
